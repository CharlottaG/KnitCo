{% extends "base.html" %}
{% load static %}

{% block page_header %}
<div class="container header-container">
    <div class="row">
        <div class="col">
        </div>
    </div>
</div>
{% block extra_title %} | Products {{ product.name}} {% endblock %}
{% endblock %}

{% block content %}
<div class="container content-container mb-5">
    <div class="row m-0 overlay">
    </div>
    <div class="row">
        <!-- Breadcrumbs -->
        <div class="row pb-4">
            <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
                <ol class="breadcrumb bg-white">
                    <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'products' %}">{{ product.category }}</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li>
                </ol>
            </nav>
        </div>
        <div class="row">
            <!-- Product image and score rating -->
            <div class="col-sm-12 col-md-6 col-lg-4">
                {% if product.average_rating %}
                <div class="d-flex z-3 position-absolute p-3">
                    <p class="px-1 text-black">
                        <i class="fa-solid fa-heart"></i> {{ product.average_rating|floatformat:2 }}
                    </p>
                </div>
                {% endif %}
                <a href="{% url 'product_detail' product.id %}">
                    <img class="card-img-top img-fluid product-img" src="{{ product.image.url }}"
                        alt="Image for {{ product.name }}">
                </a>
                <!-- For superusers to edit/delete products in shop -->
                <div>
                    {% if request.user.is_superuser %}
                    <small class="ml-3">
                        <a href="{% url 'edit_product' product.id %}" class="px-2">Edit - {{ product.name }}</a>
                        <a href="{% url 'delete_product' product.id %}" 
                            class="text-danger px-2">Delete - {{product.name }}</a>
                    </small>
                    {% endif %}
                </div>
            </div>
            <div class="col-sm-12 col-md-6 col-lg-8">
                <!-- Product details -->
                <div class="row">
                    <div class="col-8">
                        <h2 class="text-black text-align-">{{ product.name }} | <small>{{ product.brand }}</small></h2>
                    </div>
                    <div class="col-4">
                        <p class="fs-5 text-end">{{ product.price }}â‚¬</p>
                    </div>
                    <hr>
                </div>
                <div class="description mb-2">
                    <p>{{ product.description }}</p>
                </div>
                <div class="row py-2">
                    <!-- Add to shopping bag-->
                    <form class="form" action="{% url 'add_to_bag' product.id %}" method="POST">
                        {% csrf_token %}
                        <div class="d-flex-col justify-content-between">
                            <div class="col-6">
                                <p class="mt-3 text">Quantity:</p>
                                <div class="form-group">
                                    <div class="input-group">
                                        <!-- Button to decrease number of products to buy -->
                                        <div class="input-group-preprend">
                                            <button
                                                class="decrement-qty btn btn-bg-blue btn-incr-decr rounded-0 border-0"
                                                data-item_id="{{ product.id }}" id="decrement-qty_{{ product.id }}" aria-label="Decrement button">
                                                <span>
                                                    <i class="fas fa-minus"></i>
                                                </span>
                                            </button>
                                        </div>
                                        <!-- Form control -->
                                        <input class="form-control qty_input" type="number" name="quantity" value="1"
                                            min="1" max="99" data-item_id="{{ product.id }}"
                                            id="id_qty_{{ product.id }}"aria-labelledby="Quantity input for bag items">
                                        <!-- Button to increase number of products to buy -->
                                        <div class="input-group-append">
                                            <button
                                                class="increment-qty btn btn-bg-blue btn-incr-decr rounded-0 border-0"
                                                type="number" data-item_id="{{ product.id }}"
                                                id="increment-qty_{{ product.id }}" aria-label="Increment button">
                                                <span>
                                                    <i class="fas fa-plus"></i>
                                                </span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-12 col-md-6 d-flex justify-content-between">
                                <a href="{% url 'products' %}"
                                    class="btn btn-bg-blue btn-sm rounded-0 mt-1 mb-3 my-1 border-0">
                                    <span class="text-uppercase">Continue Shopping</span>
                                </a>
                                <input type="submit"
                                    class="btn btn-bg-blue btn-sm rounded-0 text-uppercase mt-1 mb-3 my-1 border-0"
                                    value="Add to Bag" aria-labelledby="Add to bag">
                            </div>
                            <input type="hidden" name="redirect_url" value="{{ request.path }}">
                        </div>
                    </form>
                </div>
                <!-- Show all available options for the product -->
                {% if all_options %}
                <div class="row">
                    <div class="row">
                        <h3>Available Options</h3>
                        <hr>
                    </div>
                    <div class="d-flex">
                        {% for option in product.all_options %}
                        <div class="p-3">
                            <a href="{% url 'product_detail' option.id %}">
                                <img class="available-options" src="{{ option.image.url }}" alt="Image for {{ option.name }}">
                                <p>{{ option.name }}</p>
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Show reviews -->
                {% if product.ratings.exists %}
                <h4>Reviews</h4>
                <div class="row">
                    <div class="col-8">
                        <a class="collapse-link" data-bs-toggle="collapse" href="#reviews" aria-expanded="false"
                            aria-controls="reviews">Click to read reviews</a>
                    </div>
                    <!-- Log in to leave a review-->
                     {% if user.is_authenticated %}
                    <div class="col-4">
                        {% else %}
                        <span class="text">
                            <a href="{% url 'account_login' %}">Log in</a> to rate and review this product
                        </span>
                        {% endif%}
                    </div>
                    
                </div>
                <!-- Collapsable section -->
                <div class="reviews my-3 collapse" id="reviews">
                    {% for rating in product.ratings.all %}
                    <div class="rating mb-2 p-3 border border-bottom" id="rating-{{rating.id}}">
                        <div class="d-flex align-items-center">
                            <p class="m-0 px-2 semibold">{{ rating.user.username }}</p>
                            <span>|</span>
                            <br>
                            <p class="px-1 text-black">
                                <i class="fa-solid fa-heart txt-grey-green"></i> {{ rating.score|floatformat:2 }}
                            </p>
                            </div>
                            <p class="m-0 px-2" id="rating-comment-{{rating.id}}">{{ rating.comment }}</p>
                            {% if rating.user == request.user %}
                            <button class="btn btn-sm bg-mid-blue mx-1 btn-edit"
                                data-rating-id="{{ rating.id }}">Edit</button>
                            <a href="{% url 'delete_rating' rating.id %}" class="btn btn-sm btn-danger mx-1 btn-delete"
                                data-rating-id="{{ rating.id }}">Delete</a>
                            {% endif %}
                        </div>
                        <div>
                            <p class="m-0 px-2 smaller lighter">{{ rating.created_at }}</p>
                        </div>
                        <!-- Edit form (hidden by default) -->
                        <form action="{% url 'edit_rating' rating.id %}" method="POST" class="edit-rating-form"
                            id="edit-rating-form-{{ rating.id }}" style="display: none;">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="score-{{ rating.id }}">Score</label>
                                <input type="number" class="form-control" name="score" id="score-{{ rating.id }}" placeholder= "{{ user.product.rating }}" value="{{ rating.score }}" min="1" max="5" step="1">
                            </div>
                            <div class="form-group">
                                <label for="comment-{{ rating.id }}">Comment</label>
                                <textarea class="form-control" name="comment" id="comment-{{ rating.id }}" rows="3">{{ rating.comment }}</textarea>
                            </div>
                            <button type="submit" class="btn btn-sm bg-mid-blue mt-2" aria-label="Update button">Update</button>
                        </form>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Add rating and review -->
                {% if request.user.is_authenticated and not user_has_rated %}
                <div class="rowrating-form border border-1 my-4">
                    <p class="p-3 text">Rate this product</p>
                    <form class="p-3 text" method="POST" action="{% url 'add_rating' product_id=product.id %}">
                        
                        {% csrf_token %}
                    <fieldset class="text">
                        <legend class="mt-1 txt-blue">Rating (1-5)</legend>
                        <input type="number" class="form-control" name="score" id="score-{{ rating.id }}" value="{{ rating.score }}" min="1" max="5" step="1">
                    <legend class="mt-1 txt-blue">Review</legend>
                        {{rating_form.comment | as_crispy_field}}
                    </fieldset>
                    
                        <button type="submit" class="btn btn-bg-blue" aria-label="Submit button">Submit</button>
                    </form>
                </div>
                {% endif %}
            </div>


        </div>
    </div>
</div>
{% endblock %}


{% block postloadjs %}
{{ block.super }}
{% include 'products/includes/quantity_input_script.html' %}

<script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function () {
        const editButtons = document.querySelectorAll(".btn-edit");
        const deleteButtons = document.querySelectorAll(".btn-delete");

        // Edit reviews
        editButtons.forEach(button => {
            button.addEventListener("click", function () {
                const ratingId = this.getAttribute("data-rating-id");
                const form = document.getElementById(`edit-rating-form-${ratingId}`);
                if (form) {
                    form.style.display = form.style.display === "none" ? "block" : "none";
                }
            });
        });

        // Delete reviews
        deleteButtons.forEach(button => {
            button.addEventListener("click", function (e) {
                e.preventDefault();
                const ratingId = this.getAttribute("data-rating-id");
                let confirmed = confirm('Are you sure you want to delete this review?');
                if (confirmed) {
                    // Create a form to submit the delete request
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = `/products/rating/${ratingId}/delete/`;
                    form.innerHTML = `
                        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                    `;
                    document.body.appendChild(form);
                    form.submit();
                }
            });
        });
    });
</script>

{% endblock %}
